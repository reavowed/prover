@import net.prover.model._
@import net.prover.model.expressions._
@(expression: Expression, reference: Option[String] = None, referrers: Set[(String, Seq[Int])] = Set.empty, safe: Boolean = false)
@* This file is incredibly whitespace sensitive! *@
@defining(referrers.filter(_._2.isEmpty).map(_._1)) { topLevelReferrers =>
  <span class="@topLevelReferrers.map("highlight-" + _).mkString(" ") @reference.map("conclusion-" + _)">@expression match {
    case ExpressionVariable(text) => {@Html(HtmlHelper.format(text))}
    case parameter: FunctionParameter => {@Html(HtmlHelper.format(parameter.toString))}
    case ExpressionApplication(text, arguments) => {@defining(
      arguments.map(argument => html.referencedStatement(argument).body.trim).mkString(", ")
    ){argumentsHtml=>@{text}(@Html(argumentsHtml))}}
    case definedExpression @ DefinedExpression(definition, components) => {@defining(
      definedExpression.scopedBoundVariableNames.map(x => HtmlHelper.format(x)) ++
      components.zipWithIndex.map { case (component, index) =>
        html.referencedStatement(
          component,
          None,
          referrers.filter(_._2.headOption.contains(index)).map(_.mapRight(_.tail)),
          true
        ).body.trim()
      }
    ){ componentsHtml =>@Html(definition.format.apply(componentsHtml, safe))}}}</span>}